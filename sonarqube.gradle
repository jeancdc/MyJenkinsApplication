task combineTestResultsForSonarqube {

    group = "Reporting"

    doLast {
        modules.each { module ->
            File combined = file("${project.buildDir}/combined-test-results")
            if (combined.exists()) {
                combined.deleteDir()
            }
            combined.mkdirs();

            def testDirs = [file("${project.buildDir}/test-results/testDebugUnitTest/"),
                            file("${project.buildDir}/outputs/androidTest-results/connected/")];
            testDirs.each { testDir ->
                if (!testDir.exists()) {
                    logging.captureStandardOutput LogLevel.WARN
                    println "WARNING: ignoring non-existant ${testDir.path}"
                    return;
                }
                files(testDir.listFiles()).each { file ->
                    if (file.isFile()) {
                        new File(combined, file.getName()) << file.text
                    }
                }
            }
        }
    }
}